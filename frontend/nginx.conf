worker_processes auto;  # Let Nginx decide the number of worker processes based on CPU cores

pid /tmp/nginx.pid;      # Store Nginx PID in /tmp (always writable in container)

events {
    worker_connections 1024;  # Max simultaneous connections per worker
}

http {
    include       /etc/nginx/mime.types;  # Load MIME types for proper content-type headers
    default_type  application/octet-stream;  # Fallback MIME type

    access_log off;             # Disable access logging to avoid permission issues
    error_log  /dev/stderr warn;  # Log errors to container stderr

    sendfile        on;         # Optimize static file serving
    tcp_nopush      on;         # Optimize TCP packet delivery
    tcp_nodelay     on;         # Reduce latency for small TCP packets
    keepalive_timeout  65;      # Keep connections alive for 65 seconds
    keepalive_requests 1000;    # Max requests per keep-alive connection

    gzip on;                    # Enable gzip compression
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;  # Types to compress
    gzip_min_length 256;        # Minimum length to compress
    gzip_vary on;               # Add Vary: Accept-Encoding header for proxies

    server {
        listen       3000;      # Port inside the container that Nginx listens on
        server_name  localhost; # Server name (not really used in Docker)

        root /usr/share/nginx/html;  # React build files root
        index index.html;            # Default file to serve

        location / {
            try_files $uri /index.html;  # Serve index.html for React client-side routing
        }

        # Serve static assets (images, CSS, JS, fonts) with long cache expiration
        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg|map)$ {
            expires 1y;                    # Cache for 1 year
            access_log off;                # Don't log these requests
            add_header Cache-Control "public, immutable";  # Indicate files won't change
        }

        # Serve files under /static/ (React default) with caching
        location /static/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
